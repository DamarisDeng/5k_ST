---
title: "0413_batch_correction"
output: html_document
---

Read data:
```{r}
library(Seurat)
library(ggplot2)
library(harmony)

object1 <- readRDS("data/preg1_cortex.rds")
object1@meta.data$sample <- "preg1"
ImageDimPlot(object1)

object2 <- readRDS("data/preg2_cortex.rds")
object2@meta.data$sample <- "preg2"
ImageDimPlot(object2)

object3 <- readRDS("data/virgin1_cortex.rds")
object3@meta.data$sample <- "virgin1"
ImageDimPlot(object3)
```

Four samples example:
```{r}
library(Seurat)
library(harmony)
library(ggplot2)
library(patchwork)

sample_files <- c(
  "preg1_cortex.rds", "preg2_cortex.rds", "preg3_cortex.rds",
  "preg4_cortex.rds", "preg5_cortex.rds", "preg6_cortex.rds",
  "virgin1_cortex.rds", "virgin2_cortex.rds", "virgin3_cortex.rds",
  "virgin4_cortex.rds", "virgin5_cortex.rds", "virgin6_cortex.rds"
)

sample_files <- c(
  "preg1_cortex.rds", "preg2_cortex.rds", "virgin5_cortex.rds", "virgin6_cortex.rds"
)
file_paths <- file.path("./data", sample_files)

# read all files
sample_list <- lapply(file_paths, readRDS)

# add names to items in list
names(sample_list) <- c(paste0("preg", 1:2), paste0("virgin", 1:2))

# add a "sample" column for all samples
sample_list <- Map(function(obj, name) {
  obj$sample <- name
  return(obj)
}, sample_list, names(sample_list))

# merge all objects
merged <- merge(sample_list[[1]], sample_list[-1], add.cell.ids = names(sample_list))

DefaultAssay(merged) <- "RNA" 

merged$sample <- as.factor(merged$sample)

# rescale the merged data
merged <- ScaleData(merged, assay = "RNA")
merged <- RunUMAP(merged, reduction = "pca", dims = 1:30, reduction.name = "umap.pca")

# run pca
merged <- RunPCA(merged, assay = "RNA")

# harmony integration
merged <- RunHarmony(merged, "sample")

# run UMAP and clustering
merged <- RunUMAP(merged, reduction = "harmony", dims = 1:30, reduction.name = "umap.harmony")

# Plot pre-Harmony UMAP
p1 <- DimPlot(merged, reduction = "umap.pca", group.by = "sample") + ggtitle("Before Harmony")

# Plot post-Harmony UMAP
p2 <- DimPlot(merged, reduction = "umap.harmony", group.by = "sample") + ggtitle("After Harmony")
p1+p2
ggsave("img/harmony_result_4_sample.png", width = 14, height = 6)
```

```{R}
# clustering on merged data
merged <- FindNeighbors(merged, reduction = "harmony", dims = 1:30)
merged <- FindClusters(merged, resolution = 0.5)

# visualize the clusters
p1 <- DimPlot(merged, reduction = "umap.harmony", group.by = "RNA_snn_res.0.5")
p2 <- ImageDimPlot(merged, group.by="RNA_snn_res.0.5")
p1 + p2
ggsave("img/clustering.png", width=14, height=6)
```
